<?python
from magicbullet.modeling import refine
from magicbullet.schema import Collection
from magicbullet.translations import translate
from magicbullet.html import Element
from magicbullet.html.form import Form, FormGroup
?>

<html
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:py="http://genshi.edgewall.org/"
    xmlns:xi="http://www.w3.org/2001/XInclude">

    <title py:match="title">
        ${translate(edited_item)}
    </title>
    
    <head py:match="head">
        ${select("*|text()")}
        <script type="text/javascript" src="/resources/scripts/tinymce/jscripts/tiny_mce/tiny_mce.js"></script>
    </head>

    <div py:match="div[@id='navigation']" py:attrs="select('@*')">
        ${select("*|text()")}
        <a id="back" href="${cms.uri(requested_item.path)}">Go back</a>
    </div>

    <h1 py:match="h1">
        ${translate(edited_item)}
    </h1>

    <div py:match="body-block">
        <?python
        form = Form()
        form.data = form_data
        form.schema = form_schema

        form.add_group(
            FormGroup(
                "translations",
                lambda member: not isinstance(member, Collection) and member.translated
            )
        )

        form.add_group(
            FormGroup(
                "properties",
                lambda member: not isinstance(member, Collection) and not member.translated
            )
        )
        
        form.add_group(
            FormGroup(
                "relations",
                lambda member: isinstance(member, Collection)
            )
        )

        @refine(form)
        def create_field(self, member):

            field = Form.create_field(self, member)

            # Add an item count next to each relation
            if isinstance(member, Collection):
                rel_count = Element("span")
                rel_count.add_class("relation_count")
                collection = self.get_member_value(self.data, member)
                print member, collection
                rel_count.append("(%d)" % len(collection))
                field.label.append(rel_count)

            return field

        def display_collection(self, obj, member):
            button = Element("button")
            button["type"] = "submit"
            button.append(translate("Edit"))
            return button        

        form.set_member_type_display(Collection, display_collection)

        # Temporary HACK!
        from magicbullet.html.tinymce import TinyMCE
        if "description" in form_schema.members():
            form.set_member_display("description", TinyMCE)
        if "body" in form_schema.members():
            form.set_member_display("body", TinyMCE)
        ?>
        ${Markup(form.render())}
    </div>

    <xi:include href="back_office_layout.html"/>

</html>
