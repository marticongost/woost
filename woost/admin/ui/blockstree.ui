<?xml version="1.0" encoding="utf-8"?>

<div
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://www.whads.com/ns/cocktail/ui"
    selectableEntriesSelector=".Entry"
    selectionType="multiple"
    appliesAlternateCSSClasses="true"
    tabindex="0">

    <ui:using mixin="cocktail.ui.Selectable"/>

    <ui:symbol name="SELECTABLE_ID_MAP"/>

    <ui:property
        name="item"
        reflected="false">
        <?on changed
        this.blocksTreeRoot.item = newValue;
        ?>
    </ui:property>

    <ui:property
        name="hoverRow"
        reflected="false">
        <?on changed
        if (oldValue) {
            oldValue.hover = false;
        }
        if (newValue) {
            newValue.hover = true;
        }
        ?>
    </ui:property>

    <?class
    createSlotDisplay(item, slot, depth = 0, isSingleSlot = false) {
        const slotDisplay = this.constructor.SlotDisplay.create();
        slotDisplay.blocksTree = this;
        slotDisplay.depth = depth;
        slotDisplay.item = item;
        slotDisplay.slot = slot;
        slotDisplay.isSingleSlot = isSingleSlot;
        slotDisplay.update();
        return slotDisplay;
    }

    createBlockDisplay(block, depth = 0) {
        const display = this.constructor.BlockDisplay.create();
        display.blocksTree = this;
        display.depth = depth;
        display.item = block;
        return display;
    }

    get selectionContainer() {
        return this.blocksTreeRoot;
    }

    resolveSelectableId(selectableId) {
        return this[SELECTABLE_ID_MAP][selectableId];
    }

    includeInEvenOddSequence(element) {
        return !element.slotInfo;
    }
    ?>

    <?js
    this[SELECTABLE_ID_MAP] = {};
    ?>

    <ui:BlocksContainer id="blocksTreeRoot">
        <?js
        element.blocksTree = this;
        element.isBlocksTreeRoot = true;
        ?>
    </ui:BlocksContainer>

    <div ui:component="Entry">

        <ui:property
            name="selectableId"
            type="string"
            reflected="true"/>

        <ui:property
            name="hover"
            type="boolean"
            reflected="true"
            default="false"/>

        <?on mouseenter
        this.parentInstance.hoverRow = this;
        ?>

        <?on mouseleave
        this.parentInstance.hoverRow = null;
        ?>

    </div>

    <div ui:component="BlocksContainer">

        <ui:symbol name="..SELECTABLE_ID_MAP"/>

        <ui:property
            name="item"
            reflected="false">
            <?on changed
            const model = cocktail.schema.getSchemaByName(newValue._class);
            const slots = [];
            for (let member of model.members()) {
                if (member instanceof woost.models.Slot) {
                    slots.push(member);
                }
            }
            for (let slot of slots) {
                const slotDisplay = this.blocksTree.createSlotDisplay(
                    newValue,
                    slot,
                    this.isBlocksTreeRoot ? 0 : this.depth + 1,
                    slots.length == 1
                );
                this.slotsList.appendChild(slotDisplay);
                if (slotDisplay.slotRow) {
                    this.blocksTree[SELECTABLE_ID_MAP][slotDisplay.slotRow.selectableId] = slotDisplay.slotRow;
                }
            }
            ?>
        </ui:property>

        <ui:property
            name="depth"
            type="number"
            reflected="true"
            default="0">
            <?on changed
            this.style.setProperty("--depth", newValue);
            ?>
        </ui:property>

        <div id="slotsList"/>

    </div>

    <div ui:component="SlotDisplay">

        <ui:symbol name="..SELECTABLE_ID_MAP"/>

        <ui:property
            name="item"
            reflected="false"/>

        <ui:property
            name="slot"
            reflected="false"/>

        <ui:property
            name="depth"
            type="number"
            reflected="true"
            default="0">
            <?on changed
            this.style.setProperty("--depth", newValue);
            ?>
        </ui:property>

        <ui:property
            name="isSingleSlot"
            type="boolean"
            reflected="true"
            default="false"/>

        <?class
        get blockDisplay() {
            return cocktail.ui.closestInstance(this, woost.admin.ui.BlocksTree.BlockDisplay);
        }

        get objectPath() {
            const blockDisplay = this.blockDisplay;
            return blockDisplay ? blockDisplay.objectPath + "-" + this.slot.name : this.slot.name;
        }

        clear() {
            cocktail.ui.empty(this);
        }

        update() {
            if (!this.isSingleSlot) {
                this.slotRow = cls.SlotRow.create();
                this.slotRow.slotInfo = {member: this.slot, container: this.item};
                this.slotBlocks.parentNode.insertBefore(this.slotRow, this.slotBlocks);
            }
            cocktail.ui.empty(this.slotBlocks);
            const blocks = this.item[this.slot.name];
            for (let block of blocks) {
                this.addBlock(block);
            }
        }

        addBlock(block) {
            const display = this.blocksTree.createBlockDisplay(block, this.depth);
            this.slotBlocks.appendChild(display);
            this.blocksTree[SELECTABLE_ID_MAP][display.blockRow.selectableId] = display.blockRow;
            return display;
        }
        ?>

        <div id="slotBlocks"/>

        <ui:woost.admin.ui.BlocksTree.Entry ui:component="SlotRow">

            <ui:property
                name="slotInfo"
                reflected="false">
                <?on changed
                this.slotHeading.innerHTML = newValue.member.translate();
                this.selectableId = `slot-${newValue.container.id}-${newValue.member.name}`;
                ?>
            </ui:property>

            <div id="slotHeading"/>

        </ui:woost.admin.ui.BlocksTree.Entry>

    </div>

    <ui:BlocksContainer ui:component="BlockDisplay">

        <ui:property
            name="disabledBlock"
            type="boolean"
            reflected="true"
            default="false"/>

        <?class
        get slotDisplay() {
            return cocktail.ui.closestInstance(this, woost.admin.ui.BlocksTree.SlotDisplay);
        }

        get blockIndex() {
            if (!this.parentNode) {
                return -1;
            }
            return Array.from(this.parentNode.children).indexOf(this);
        }

        get objectPath() {
            const slotDisplay = this.slotDisplay;
            const blockIndex = this.blockIndex;
            if (slotDisplay && blockIndex != -1) {
                return slotDisplay.objectPath + "-" + blockIndex;
            }
            return "";
        }
        ?>

        <ui:BlockRow id="blockRow" ui:placement="before slotsList"/>

        <?on item:changed
        const blockType = cocktail.schema.getSchemaByName(newValue._class);
        this.disabledBlock = !newValue.enabled;
        this.blockRow.dataBinding = {
            member: new cocktail.schema.Reference({type: blockType}),
            value: newValue
        };
        ?>

        <ui:woost.admin.ui.BlocksTree.Entry ui:component="BlockRow">

            <?class
            get blockDisplay() {
                return cocktail.ui.closestInstance(this, woost.admin.ui.BlocksTree.BlockDisplay);
            }

            get slotDisplay() {
                return cocktail.ui.closestInstance(this, woost.admin.ui.BlocksTree.SlotDisplay);
            }

            get blockIndex() {
                const blockDisplay = this.blockDisplay;
                return blockDisplay && blockDisplay.blockIndex;
            }

            get objectPath() {
                const blockDisplay = this.blockDisplay;
                return blockDisplay && blockDisplay.objectPath;
            }
            ?>

            <ui:using mixin="cocktail.ui.DataDisplay"/>

            <?on value:changed
            const blockType = cocktail.schema.getSchemaByName(newValue._class);
            this.selectableId = `block-${newValue.id}`;
            this.icon.src = blockType[woost.admin.ui.modelIconURL];
            this.descriptionLabel.innerHTML = blockType.translateValue(newValue);
            this.typeLabel.innerHTML = blockType.translate();
            ?>

            <ui:cocktail.ui.SVG id="icon"/>

            <div id="blockInfo">
                <div id="descriptionLabel"/>
                <div id="typeLabel"/>
            </div>

        </ui:woost.admin.ui.BlocksTree.Entry>

    </ui:BlocksContainer>

</div>

